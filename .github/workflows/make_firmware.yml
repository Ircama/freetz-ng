name: make_firmware

on:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/make_firmware.yml'
  workflow_dispatch:
    inputs:
      url:
        description: "URL of .tar, .tgz, .tbz or .config, empty for URL in secrets.ACTIONS_TESTER (gh param: -f url=https://example.com/config)"
        required: false
        default: ""
      verbosity:
        description: "Verbosity level (0=quiet, 1=normal, 2=verbose, gh param: -f verbosity=2)"
        required: false
        default: "0"
        type: choice
        options:
          - "0"
          - "1"
          - "2"
      download_toolchain:
        description: "Try to download precompiled toolchain (gh param: -f download_toolchain=true)"
        required: false
        default: false
        type: boolean
      cancel_previous:
        description: "Cancel previous runs of this workflow (gh param: -f cancel_previous=false)"
        required: false
        default: true
        type: boolean
      override_device:
        description: "Override device (e.g., 7530_W6_V1, 7590_W6, 6670, empty to use config, gh param: -f override_device=7530_W6_V1)"
        required: false
        default: ""
      override_firmware:
        description: "Override firmware version (e.g., 08_2X, 08_0X, 07_5X, empty to use config, gh param: -f override_firmware=08_2X)"
        required: false
        default: ""
      override_lang:
        description: "Override language (EN or DE, empty to use config, gh param: -f override_lang=EN)"
        required: false
        default: ""

concurrency:
  group: ${{ github.event.inputs.cancel_previous != 'false' && github.workflow || format('{0}-{1}', github.workflow, github.run_id) }}
  cancel-in-progress: ${{ github.event.inputs.cancel_previous != 'false' }}

jobs:
  build:
    container:
      image: ghcr.io/freetz-ng/firmware
      options: --user 1001:1001
    runs-on: ubuntu-latest

    env:
      CACHE_KEY: "${{ github.workflow }}"
    steps:

      - name: clone
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          set-safe-directory: true
          repository: ${{ github.repository }}
          ref: ${{ github.ref_name }}
          path: ${{ github.workspace }}
          fetch-depth: 0
          clean: false
          persist-credentials: true

      - name: cache
        uses: actions/cache@v4
        if: always()
        with:
          path: |
            dl/*
            dl/fw/*
          key: ${{ env.CACHE_KEY }}-${{ github.run_id }}
          restore-keys: |
            ${{ env.CACHE_KEY }}

      - name: download
        run: |
          truncate -s0                                                                                  .config
          echo -n
          URL="$(echo '${{ github.event.inputs.url }}' | sed 's/^ *//;s/ *$//')"
          [ -z "$URL" ] && URL="${{ secrets.ACTIONS_TESTER }}"
          echo -n "Downloading file '${URL##*/}': "
          case "${URL##*.}" in \
          '')                                                                       echo Skip ;; \
          tar) wget -q "$URL" -O - 2>/dev/null | tar x  2>/dev/null && echo Done || echo Fail ;; \
          tgz) wget -q "$URL" -O - 2>/dev/null | tar xz 2>/dev/null && echo Done || echo Fail ;; \
          tbz) wget -q "$URL" -O - 2>/dev/null | tar xj 2>/dev/null && echo Done || echo Fail ;; \
          *)   wget -q "$URL" -O - 2>/dev/null > .config            && echo Done || echo Fail ;; \
          esac
          echo -n
          sed '/FREETZ_SERIES_/d'                                                                     -i .config
          echo 'FREETZ_SERIES_ALL=y'                                                                  >> .config
          sed '/FREETZ_TOOLCHAIN_CCACHE/d'                                                            -i .config
          echo '# FREETZ_TOOLCHAIN_CCACHE is not set'                                                 >> .config
          sed '/FREETZ_USER_LEVEL_/d'                                                                 -i .config
          echo 'FREETZ_USER_LEVEL_DEVELOPER=y'                                                        >> .config
          sed '/FREETZ_HOSTTOOLS_DOWNLOAD/d'                                                          -i .config
          echo 'FREETZ_HOSTTOOLS_DOWNLOAD=y'                                                          >> .config
          sed '/FREETZ_DOWNLOAD_TOOLCHAIN/d'                                                          -i .config
          if [ "${{ github.event.inputs.download_toolchain }}" = "true" ]; then
            echo 'FREETZ_DOWNLOAD_TOOLCHAIN=y'                                                        >> .config
          else
            echo '# FREETZ_DOWNLOAD_TOOLCHAIN is not set'                                             >> .config
            sed '/FREETZ_BUILD_TOOLCHAIN/d'                                                           -i .config
            echo 'FREETZ_BUILD_TOOLCHAIN=y'                                                           >> .config
          fi
          sed '/FREETZ_VERBOSITY_FWMOD_/d'                                                            -i .config
          echo 'FREETZ_VERBOSITY_FWMOD_2=y'                                                           >> .config
          sed '/FREETZ_VERBOSITY_LEVEL/d'                                                             -i .config
          VERBOSITY="${{ github.event.inputs.verbosity }}"
          [ -z "$VERBOSITY" ] && VERBOSITY="0"
          echo "FREETZ_VERBOSITY_LEVEL_${VERBOSITY}=y"                                                >> .config
          echo "FREETZ_VERBOSITY_LEVEL=${VERBOSITY}"                                                  >> .config
          sed '/FREETZ_SIZEINFO_COMPRESSED/d'                                                         -i .config
          echo 'FREETZ_SIZEINFO_COMPRESSED=y'                                                         >> .config
          sed '/FREETZ_SIZEINFO_UNCOMPRESSED/d'                                                       -i .config
          echo 'FREETZ_SIZEINFO_UNCOMPRESSED=y'                                                       >> .config
          sed '/FREETZ_JLEVEL/d'                                                                      -i .config
          echo 'FREETZ_JLEVEL=0'                                                                      >> .config
          sed '/FREETZ_CHECK_CHANGED/d'                                                               -i .config
          echo '# FREETZ_CHECK_CHANGED is not set'                                                    >> .config
          sed '/FREETZ_MODULES_TEST/d'                                                                -i .config
          echo '# FREETZ_MODULES_TEST is not set'                                                     >> .config
          if [ -n "${{ github.event.inputs.override_device }}" ]; then
            echo "Overriding device to: ${{ github.event.inputs.override_device }}"
            sed -i 's/^FREETZ_TYPE_[0-9A-Z_]*=y/# &/' .config
            echo "FREETZ_TYPE_${{ github.event.inputs.override_device }}=y"                           >> .config
            make olddefconfig
          fi
          if [ -n "${{ github.event.inputs.override_firmware }}" ]; then
            echo "Overriding firmware to: ${{ github.event.inputs.override_firmware }}"
            sed -i 's/^FREETZ_TYPE_FIRMWARE_.*=y/# &/' .config
            echo "FREETZ_TYPE_FIRMWARE_${{ github.event.inputs.override_firmware }}=y"                >> .config
            make olddefconfig
          fi
            if [ -n "${{ github.event.inputs.override_lang }}" ]; then
              echo "Overriding language to: ${{ github.event.inputs.override_lang }}"
              sed -i 's/^FREETZ_TYPE_LANG_[A-Z][A-Z]=y/# &/' .config
              case "${{ github.event.inputs.override_lang }}" in
                EN|en) echo "FREETZ_TYPE_LANG_EN=y" >> .config ;;
                DE|de) echo "FREETZ_TYPE_LANG_DE=y" >> .config ;;
                *) echo "Unknown language: ${{ github.event.inputs.override_lang }}" ;;
              esac
              make olddefconfig
            fi
          echo "##########################################################" && echo -n "Lines=" && wc -l .config
          echo "##########################################################"
          echo "Configuration summary:"
          echo "  Device:   $(grep '^FREETZ_TYPE_[0-9A-Z_]*=y' .config | grep -v '_LANG\|_LANGUAGE\|_FIRMWARE\|_DSL\|_PREFIX' | sed 's/FREETZ_TYPE_//;s/=y//' | head -1)"
          echo "  Firmware: $(grep '^FREETZ_TYPE_FIRMWARE_.*=y' .config | sed 's/FREETZ_TYPE_FIRMWARE_//;s/=y//' | head -1)"
          echo "  Kernel:   $(grep '^FREETZ_AVM_PROP_KERNEL_' .config | grep '=y' | sed 's/.*KERNEL_//;s/_/./g;s/=y//' | head -1)"
          echo "  Arch:     $(grep '^FREETZ_AVM_PROP_ARCH_' .config | grep '=y' | sed 's/.*ARCH_//;s/=y//' | head -1)"
          echo "  GCC:      $(grep '^FREETZ_TARGET_GCC_' .config | grep -v MIN | grep -v MAX | grep '=y' | sed 's/.*GCC_//;s/_/./g;s/=y//' | head -1)"
          echo "  uClibc:   $(grep '^FREETZ_TARGET_UCLIBC_' .config | grep -v HAS | grep '=y' | sed 's/.*UCLIBC_//;s/_/./g;s/=y//' | head -1)"
          echo ""
          echo "User packages enabled:"
          grep '^FREETZ_PACKAGE_.*=y' .config | grep -v 'DROPBEAR\|DTC\|HASERL\|INETD\|JUIS_CHECK\|PACKAGE_MOD\|MODCGI\|AUTHORIZED_KEYS\|SYSLOGD_CGI' | sed 's/FREETZ_PACKAGE_//;s/=y//' | head -15 | sed 's/^/  - /'
          echo "##########################################################"

      - name: generate
        run: |
          make && rm -f images/latest.image
        continue-on-error: true
        id: build
        
      - name: debug-on-failure
        if: steps.build.outcome == 'failure'
        run: |
          echo "##########################################################"
          echo "Build failed - showing diagnostic information"
          echo "##########################################################"
          
          # Test g++ compiler
          GXX_PATH=$(find toolchain/build -name "arm-linux-uclibcgnueabi-g++" -type f 2>/dev/null | head -1)
          if [ -n "$GXX_PATH" ]; then
            echo ""
            echo "=== G++ Compiler Information ==="
            echo "Found g++ at: $GXX_PATH"
            echo ""
            echo "File info:"
            file "$GXX_PATH" || true
            echo ""
            echo "Testing g++ version:"
            "$GXX_PATH" --version 2>&1 || echo "ERROR: g++ --version failed"
            echo ""
            echo "Checking g++ dependencies:"
            ldd "$GXX_PATH" 2>&1 || echo "ERROR: ldd failed"
            echo ""
            echo "Testing simple C++ compile:"
            echo 'int main() { return 0; }' > /tmp/test.cpp
            "$GXX_PATH" /tmp/test.cpp -o /tmp/test.out 2>&1 || echo "ERROR: Simple compile failed"
            rm -f /tmp/test.cpp /tmp/test.out
            echo ""
            echo "Checking target ARM libstdc++:"
            find toolchain/build -name "libstdc++.so*" -path "*/arm-linux-uclibcgnueabi/*" | head -5
            echo ""
            echo "Checking if g++-wrapper exists and what it points to:"
            WRAPPER=$(find toolchain/build -name "arm-linux-uclibcgnueabi-g++-wrapper" | head -1)
            if [ -n "$WRAPPER" ]; then
              ls -la "$WRAPPER"
              readlink -f "$WRAPPER" || true
            fi
            echo ""
          else
            echo "WARNING: g++ not found in toolchain"
          fi
          
          # Show config.log for patchelf
          echo "=== Patchelf config.log (last 200 lines) ==="
          find source -name "config.log" -path "*/patchelf*/config.log" -exec echo "=== {} ===" \; -exec tail -200 {} \; 2>/dev/null || echo "No config.log found"
          echo "##########################################################"
          
      - name: fail-if-build-failed
        if: steps.build.outcome == 'failure'
        run: exit 1

      - name: result
        run: |
          echo "##########################################################"
          ls -l images/
          sha256sum images/*

      - name: vars
        id: vars
        run: |
          LINK="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          LAST="$(ls images/*.image | sed 's,.*/,,;s,\.image$,,')"
          NAME="$(ls images/*.image | sed 's,.*/,,;s,_[0-9].*,,')"
          [ -n "$LINK" ] && echo "link=$LINK" >> $GITHUB_OUTPUT
          [ -n "$LAST" ] && echo "last=$LAST" >> $GITHUB_OUTPUT
          [ -n "$NAME" ] && echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "##########################################################"
          echo "LINK=$LINK"
          echo "LAST=$LAST"
          echo "NAME=$NAME"
          test -n "$NAME"
      - name: artifact
        id: artifact
        uses: actions/upload-artifact@v4
        if: github.repository != 'freetz-ng/freetz-ng'
        with:
          name: ${{ steps.vars.outputs.last }}.zip
          path: images/
          if-no-files-found: warn
          retention-days: 1
          compression-level: 0
          overwrite: true
          include-hidden-files: false
      - name: link
        if: github.repository != 'freetz-ng/freetz-ng'
        run: |
          echo "##########################################################"
          FILE="${{ steps.vars.outputs.last }}.zip"
          ARTI="${{ steps.artifact.outputs.artifact-url }}"
          echo "Firmware := $FILE"
          echo "Artifact := $ARTI"


